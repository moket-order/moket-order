<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MOKET - ëª¨ë‘ë¥¼ ìœ„í•œ ê³µêµ¬ë§ˆì¼“</title>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
    <style>
        /* [1] ì›ë³¸ ì£¼ë¬¸ì„œ2.html ìŠ¤íƒ€ì¼ ë³€ìˆ˜ ë° ë ˆì´ì•„ì›ƒ ì™„ë²½ ë³´ì¡´ */
        :root {
            --moket-green: #4CAF50;
            --white: #FFFFFF;
            --font-main: 'Pretendard', sans-serif;
            --common-radius: 26px;
            --target-height: 42px;
            /* ìƒì„¸ë³´ê¸° ë²„íŠ¼ ë†’ì´ (ê¸°ì¡´ ì›ë³µ) */
            --qty-height: 38px;
            /* ìˆ˜ëŸ‰ ì¡°ì ˆë°” ì „ìš© ë†’ì´ (ìƒˆë¡œ ìƒì„±) */
            --btn-radius: 12px;
            --nego-orange: #FF6D00;
            --item-black: #1a1a1a;
            --btn-font-size: 1.05rem;
            --btn-font-weight: 800;
        }

        body {
            font-family: var(--font-main);
            background: #f4f6f8;
            margin: 0;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            letter-spacing: -0.02em;
            -webkit-font-smoothing: antialiased;
            word-break: keep-all;
            transition: padding-bottom 0.3s ease;
        }

        body.has-selection {
            padding-bottom: calc(140px + env(safe-area-inset-bottom));
        }

        /* í—¤ë”: í–„ë²„ê±° ë©”ë‰´ë¥¼ ìœ„í•´ ì •ë ¬ë§Œ ì¶”ê°€ */
        .header {
            background: var(--moket-green);
            padding: calc(45px + env(safe-area-inset-top)) 20px 20px 20px;
            display: grid;
            grid-template-columns: 70px 1fr 70px;
            align-items: end;
            /* ë°”ë‹¥(í•œê¸€ í…ìŠ¤íŠ¸) ê¸°ì¤€ ì •ë ¬ */
            justify-items: center;
        }

        .header-center {
            text-align: center;
            cursor: pointer;
        }

        .slogan {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 800;
            letter-spacing: 0.2em;
            margin-bottom: 3px;
        }

        .logo-en {
            color: var(--white);
            font-size: 2.8rem;
            font-weight: 900;
            letter-spacing: 0.05em;
            line-height: 0.8;
            margin-bottom: 3px;
        }

        .logo-ko {
            color: var(--white);
            font-size: 1rem;
            font-weight: 800;
            letter-spacing: 0.45em;
            text-indent: 0.45em;
            line-height: 1;
        }

        /* í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ */
        .menu-btn {
            justify-self: start;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 13px;
            /* ì˜ì–´ ë¡œê³  ì¤‘ì•™ì— ë§ì¶”ê¸° ìœ„í•œ ê°„ê²© ì¡°ì • */
            cursor: pointer;
            z-index: 1001;
        }

        .menu-icons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .menu-icons span {
            display: block;
            width: 24px;
            height: 3px;
            background-color: var(--white);
            border-radius: 2px;
        }

        .btn-label {
            font-size: 1rem;
            font-weight: 800;
            color: var(--white);
            line-height: 1;
            letter-spacing: -0.02em;
        }

        /* ì‚¬ì´ë“œ ë©”ë‰´ ë“œë¡œì–´ */
        .side-menu {
            position: fixed;
            top: 0;
            left: -200px;
            width: 200px;
            height: 100%;
            background: var(--white);
            z-index: 5000;
            transition: 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .side-menu.open {
            left: 0;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.15);
        }

        .side-menu-header {
            background: var(--moket-green);
            padding: calc(45px + env(safe-area-inset-top)) 20px 15px 20px;
            /* í•˜ë‹¨ íŒ¨ë”© 20px -> 15px */
            color: var(--white);
        }

        .side-menu-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 900;
        }

        .side-menu-header p {
            margin: 10px 0 0 0;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .name-badge {
            background: var(--white);
            color: var(--nego-orange);
            padding: 4px 12px;
            border-radius: 20px;
            margin-right: 6px;
            font-weight: 900;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .side-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4999;
            backdrop-filter: blur(2px);
        }

        .menu-list {
            list-style: none;
            padding: 10px 25px;
            margin: 0;
        }

        .menu-list li {
            padding: 18px 0;
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 1px solid #f5f5f5;
            color: var(--item-black);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ê³µí†µ ë²„íŠ¼ ì‹œìŠ¤í…œ (ë‹«ê¸° ë²„íŠ¼ í†µì¼) */
        .btn-common {
            width: 100%;
            height: 60px;
            border-radius: 16px;
            font-weight: 900;
            font-size: 1.25rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            margin-top: 10px;
        }

        .btn-close {
            background: #eff2f5;
            color: #455464;
        }

        .btn-primary {
            background: var(--moket-green);
            color: #fff;
        }

        .btn-naver {
            background: #03C75A;
            color: #fff;
        }

        .btn-kakao {
            background: #FEE500;
            color: #191919;
            margin-bottom: 12px;
            width: 100%;
        }

        /* [ì¶”ê°€] ì´ˆê¸° ë¡œê·¸ì¸ ê°•ì œ ìŠ¤íƒ€ì¼ */
        #profile-modal.login-forced .input-group,
        #profile-modal.login-forced .btn-primary,
        #profile-modal.login-forced .btn-close {
            display: none;
        }

        #profile-modal .login-msg {
            display: none;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: #455464;
            line-height: 1.5;
        }

        #profile-modal.login-forced .login-msg {
            display: block;
        }

        /* ëª¨ë‹¬ ì‹œìŠ¤í…œ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            /* ë” ì§„í•˜ê²Œ ë³€ê²½ */
            z-index: 6000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: #ffffff !important;
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 85%;
            max-width: 450px;
            overflow: hidden;
            padding: 25px;
            box-sizing: border-box;
        }

        /* ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì „ìš© */
        #detail-overlay .modal-content,
        #history-modal .modal-content {
            width: calc(100% - 20px);
            /* ì¢Œìš° 10pxì”© ì—¬ë°± */
            max-width: 580px;
            height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 55px);
            /* ìƒë‹¨(45px) + í•˜ë‹¨(10px) ì—¬ë°± */
            padding: 0;
            display: flex;
            flex-direction: column;
            margin-top: calc(45px + env(safe-area-inset-top));
            /* ë…¸ì¹˜/ì•„ì¼ëœë“œ ê°€ë ¤ì§ ë°©ì§€ */
            margin-bottom: calc(10px + env(safe-area-inset-bottom));
            /* í•˜ë‹¨ 10px ì—¬ë°± ìœ ì§€ */
        }

        .slider-wrapper {
            width: 100%;
            aspect-ratio: 1 / 1;
            /* ì •ë°©í˜•(1:1)ìœ¼ë¡œ ê³ ì • */
            position: relative;
            background: #f9f9f9;
            cursor: pointer;
            overflow: hidden;
        }

        .slider-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            width: 100%;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }

        .slider-container img {
            min-width: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ì˜ì—­ ì±„ìš°ê¸° */
            background: #fff;
            scroll-snap-align: start;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--moket-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .touch-guide {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            pointer-events: none;
        }

        .detail-body {
            padding: 20px 10px 20px 20px;
            flex: 1;
            overflow-y: auto;
        }

        /* ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ & ì¹´ë“œ ì›ë³¸ ìœ ì§€ */
        .sticky-header-group {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--white);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .date-section-title {
            padding: 10px 20px 5px 20px;
            font-size: 1.15rem;
            font-weight: 900;
            color: var(--item-black);
            text-align: center;
        }

        .date-filter-container {
            padding: 5px 0 10px 0;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-left: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .date-filter-container::-webkit-scrollbar {
            display: none;
        }

        .date-btn {
            flex-shrink: 0;
            padding: 0 10px;
            /* ê¸°ì¡´ 16pxì—ì„œ 10pxë¡œ ì¶•ì†Œ */
            height: 38px;
            border-radius: var(--btn-radius);
            background: #fafafa;
            color: #455464;
            font-size: 1.15rem;
            font-weight: 800;
            border: 1.5px solid #eee;
            cursor: pointer;
        }

        .date-btn.active {
            background: var(--moket-green);
            color: var(--white);
            border-color: var(--moket-green);
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .product-card {
            background: var(--white);
            border-radius: var(--common-radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            /* Changed to vertical */
            gap: 15px;
            box-sizing: border-box;
            transition: transform 0.2s ease;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .card-layout {
            display: flex;
            flex-direction: column;
            /* Vertical stack */
            gap: 18px;
            width: 100%;
        }

        .left-col {
            width: 130px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .thumb {
            width: 100%;
            /* Full width in vertical layout */
            aspect-ratio: 1 / 0.9;
            /* Slightly wider than tall to reduce height */
            height: auto;
            border-radius: 24px;
            background-color: #f9f9f9;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .slider-no-img {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            color: #ccc;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn-detail {
            width: 100%;
            height: var(--target-height);
            border: 1.5px solid #eee;
            background: #fafafa;
            border-radius: var(--btn-radius);
            color: #555;
            font-size: var(--btn-font-size);
            font-weight: var(--btn-font-weight);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: auto;
            /* Push to bottom of left column */
        }

        .right-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 0;
            /* Fix for text wrapping in flex */
        }

        .item-info-top {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item-controls-bottom-v {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
            margin-top: 10px;
        }

        .action-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .item-name {
            font-weight: 800;
            font-size: 1.35rem;
            /* Slightly larger in vertical layout */
            color: var(--item-black);
            line-height: 1.4;
            word-break: break-all;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .item-price-val {
            color: var(--nego-orange);
            font-weight: 900;
            font-size: 1.25rem;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fafafa;
            padding: 0 8px;
            border-radius: 12px;
            height: var(--qty-height);
            /* ì „ìš© ë³€ìˆ˜ ì‚¬ìš© */
            border: 1.5px solid #eee;
            transition: all 0.2s ease;
        }

        .qty-controls.selected {
            background: #eef9f2;
            /* ìˆ˜ëŸ‰ì´ 1 ì´ìƒì¼ ë•Œ ë°°ê²½ìƒ‰ (ì—°í•œ ë…¹ìƒ‰í†¤) */
            border-color: var(--moket-green);
        }

        .qty-controls:active {
            background: #f0f0f0;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: white;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: 800;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s ease;
            color: var(--item-black);
        }

        .qty-btn:active {
            background: var(--moket-green) !important;
            color: white !important;
            transform: scale(0.9);
            box-shadow: none;
        }

        @media (hover: hover) {
            .qty-btn:hover {
                background: #f0f0f0;
            }
        }

        .qty-num {
            width: 32px;
            text-align: center;
            border: none;
            background: none;
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--moket-green);
        }

        /* í‘¸í„° */
        .footer {
            position: fixed;
            bottom: -160px;
            width: 100%;
            background: var(--white);
            padding: 12px 20px calc(15px + env(safe-area-inset-bottom)) 20px;
            box-sizing: border-box;
            box-shadow: 0 -8px 25px rgba(0, 0, 0, 0.12);
            z-index: 100;
            max-width: 600px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.4s ease;
        }

        .footer.visible {
            bottom: 0;
        }

        .main-submit-btn {
            width: 100%;
            height: 54px;
            background: var(--moket-green);
            color: var(--white);
            border: none;
            border-radius: 18px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
        }

        /* ì „ì²´í™”ë©´ í™•ëŒ€ */
        #fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 7000;
            flex-direction: column;
        }

        .fullscreen-slider {
            flex: 1;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .fullscreen-slider::-webkit-scrollbar {
            display: none;
        }

        .fullscreen-slide {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            scroll-snap-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: calc(20px + env(safe-area-inset-top));
            right: calc(20px + env(safe-area-inset-right));
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            z-index: 7101;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        /* ì •ë³´ë³€ê²½ ëª¨ë‹¬ìš© ì…ë ¥ì°½ */
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .modal-input {
            width: 100%;
            height: 50px;
            border: 1.5px solid #eee;
            border-radius: 12px;
            padding: 0 15px;
            box-sizing: border-box;
            font-size: 1rem;
            margin-top: 8px;
            outline: none;
        }

        .input-hint {
            font-size: 0.85rem;
            color: #455464;
            margin-top: 6px;
            line-height: 1.4;
        }

        /* ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ */
        .cart-btn {
            justify-self: end;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 9px;
            /* ì˜ì–´ ë¡œê³  ì¤‘ì•™ì— ë§ì¶”ê¸° ìœ„í•œ ê°„ê²© ì¡°ì • */
            cursor: pointer;
            color: var(--white);
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="menu-btn" onclick="toggleMenu()">
            <div class="menu-icons"><span></span><span></span><span></span></div>
            <span class="btn-label">ë©”ë‰´</span>
        </div>
        <div class="header-center" onclick="location.reload()">
            <div class="slogan">ëª¨ë‘ë¥¼ ìœ„í•œ ê³µêµ¬ë§ˆì¼“</div>
            <div class="logo-en">MOKET</div>
            <div class="logo-ko">ëª¨ì¼“</div>
        </div>
        <div class="cart-btn" onclick="openHistoryModal()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.6"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
                <path d="M3 6h18"></path>
                <path d="M16 10a4 4 0 0 1-8 0"></path>
            </svg>
            <span class="btn-label">ì£¼ë¬¸ë‚´ì—­</span>
        </div>
    </div>
    <div id="side-menu-overlay" class="side-menu-overlay" onclick="toggleMenu()"></div>
    <div id="side-menu" class="side-menu">
        <div class="side-menu-header" style="text-align: center;">
            <div onclick="location.reload()" style="cursor: pointer;">
                <div class="slogan" style="font-size: 0.75rem; color: rgba(255,255,255,0.85);">ëª¨ë‘ë¥¼ ìœ„í•œ ê³µêµ¬ë§ˆì¼“</div>
                <div class="logo-en" style="font-size: 2.2rem;">MOKET</div>
                <div class="logo-ko" style="font-size: 0.8rem; letter-spacing: 0.35em; text-indent: 0.35em;">ëª¨ì¼“</div>
            </div>
            <p id="menu-greeting" style="margin-top: 10px; justify-content: center;"><span
                    class="name-badge">ì£¼ë¬¸ì</span>ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤</p>
        </div>
        <ul class="menu-list">
            <li onclick="openSideModal('profile-modal')">ì£¼ë¬¸ìëª… ë³€ê²½</li>
            <li onclick="openSideModal('location-modal')">ë§¤ì¥ìœ„ì¹˜</li>
            <li onclick="openSideModal('hours-modal')">ì˜ì—…ì‹œê°„</li>
            <li onclick="window.open('https://pf.kakao.com/')">ì¹´ì¹´ì˜¤í†¡ 1:1 ë¬¸ì˜í•˜ê¸°</li>
        </ul>
    </div>
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="profile-modal-title" style="margin-top:0; font-weight:900; text-align:center;">ì£¼ë¬¸ì ì •ë³´ ë³€ê²½</h3>
            <div class="login-msg">
                ëª¨ì¼“ì— ì˜¤ì‹  ê³ ê°ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤!<br>ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹œë ¤ë©´ <b>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</b>ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </div>
            <div class="input-group"><strong>ì£¼ë¬¸ìëª…</strong><input id="input-name" type="text" class="modal-input"
                    placeholder="ì£¼ë¬¸ìëª… ì…ë ¥">
                <div class="input-hint">ì˜¤í”ˆì±„íŒ…ë°© ë‹‰ë„¤ì„ìœ¼ë¡œ ì…ë ¥ í•´ ì£¼ì„¸ìš”.</div>
            </div>
            <div class="input-group"><strong>ì—°ë½ì²˜</strong><input id="input-phone" type="tel" class="modal-input"
                    placeholder="010-0000-0000">
                <div class="input-hint">ì£¼ë¬¸ë‚´ì—­ì„ ë°›ì•„ë³´ì‹¤ ì—°ë½ì²˜ë¥¼ ì…ë ¥ í•´ ì£¼ì„¸ìš”.</div>
            </div>
            <button id="btn-kakao-login" class="btn-common btn-kakao" onclick="loginWithKakao()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="margin-right:8px;">
                    <path
                        d="M10 3C5.582 3 2 5.835 2 9.333c0 2.27 1.517 4.256 3.82 5.41l-.97 3.543c-.06.22.185.397.378.27l4.162-2.735c.203.01.41.015.61.015 4.418 0 8-2.835 8-6.333S14.418 3 10 3z" />
                </svg>
                ì¹´ì¹´ì˜¤ë¡œ 1ì´ˆ ë¡œê·¸ì¸
            </button>
            <button class="btn-common btn-primary" onclick="saveProfile()">ì €ì¥í•˜ê¸°</button><button
                class="btn-common btn-close" onclick="closeModal('profile-modal')">ë‹«ê¸°</button>
        </div>
    </div>
    <div id="save-confirm-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center; width: 80%; max-width: 300px; padding: 30px 20px;">
            <h3 style="margin: 0; font-weight: 900; font-size: 1.3rem;">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
        </div>
    </div>
    <div id="location-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <h3 style="margin-top:0; font-weight:900;">ë§¤ì¥ ìœ„ì¹˜</h3>
            <p style="font-size:1.1rem; font-weight:700; margin:20px 0; line-height:1.5;">ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ ë‹¤ì‚°ì¤‘ì•™ë¡œ82ë²ˆê¸¸ 106</p><a
                href="https://map.naver.com/v5/search/ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ ë‹¤ì‚°ì¤‘ì•™ë¡œ82ë²ˆê¸¸ 106" target="_blank"
                class="btn-common btn-naver">ë„¤ì´ë²„ ì§€ë„ë¡œ ë³´ê¸°</a><button class="btn-common btn-close"
                onclick="closeModal('location-modal')">ë‹«ê¸°</button>
        </div>
    </div>
    <div id="hours-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; font-weight:900; text-align:center;">ì˜ì—…ì‹œê°„ ì•ˆë‚´</h3>
            <div style="line-height:2.2; font-weight:700; font-size:1rem; margin-bottom:10px; text-align: center;">â€¢ í‰ì¼:
                10:00 - 19:00<br>â€¢ í† ìš”ì¼: 11:00 - 17:00<br>â€¢ ì¼ìš”ì¼/ê³µíœ´ì¼: íœ´ë¬´ </div><button class="btn-common btn-close"
                onclick="closeModal('hours-modal')">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="sticky-header-group">
        <div class="date-section-title">í”½ì—…ì¼ë³„ ìƒí’ˆ ëª©ë¡</div>
        <div class="date-filter-container" id="date-filters"></div>
    </div>
    <div class="container" id="product-list"></div>
    <div id="detail-overlay" class="modal-overlay" onclick="if(event.target === this) closeModal('detail-overlay')">
        <div class="modal-content">
            <div class="slider-wrapper" onclick="openFullscreen()">
                <div class="slider-container" id="slider-area"></div>
                <div class="touch-guide">íƒ­í•˜ì—¬ í™•ëŒ€ë³´ê¸°</div>
            </div>
            <div class="detail-body">
                <h2 id="detail-title" style="margin:0; font-size:1.6rem; font-weight:900; color:var(--item-black);">
                </h2>
                <div id="detail-price"
                    style="color:var(--nego-orange); font-weight:900; font-size:1.5rem; margin:10px 0;"></div>
                <div id="detail-desc" style="white-space:pre-wrap; color:#455464; font-size:1.05rem; line-height:1.6;">
                </div>
            </div>
            <div style="padding: 12px 20px; border-top: 1px solid #f5f5f5;"><button class="btn-common btn-close"
                    onclick="closeModal('detail-overlay')"
                    style="height: 42px; font-size: 1.1rem; margin-top: 0;">ë‹«ê¸°</button></div>
        </div>
    </div>
    <div id="fullscreen-overlay">
        <button class="fullscreen-close"
            onclick="document.getElementById('fullscreen-overlay').style.display='none'; checkScrollLock();">&times;</button>
        <div class="fullscreen-slider" id="fullscreen-slider-area"></div>
    </div>
    <div id="confirm-overlay" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <div id="confirm-item-list"
                style="text-align:left; background:#f5f5f5; padding:18px; border-radius:18px; margin:10px 0 20px 0; font-size:1rem; line-height:1.7; max-height:350px; overflow-y:auto;">
            </div>
            <div style="font-weight:900; font-size:1.35rem; margin-bottom:15px;">ì´ í•©ê³„: <span id="confirm-total-price"
                    style="color:var(--nego-orange);">0ì›</span></div>
            <div style="display:flex; gap:10px;"><button class="btn-common btn-close"
                    onclick="closeModal('confirm-overlay')">ì·¨ì†Œ</button><button id="btn-submit-order"
                    class="btn-common btn-primary" onclick="completeOrder()">ì£¼ë¬¸í™•ì •</button></div>
            <div
                style="font-size:0.85rem; color:#455464; margin-top:15px; font-weight:800; text-align:center; word-break:keep-all;">
                ìˆ˜ëŸ‰ë³€ê²½ ë° ì£¼ë¬¸ì·¨ì†ŒëŠ” ì£¼ë¬¸ë‹¹ì¼ 24ì‹œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
        </div>
    </div>
    <div class="footer" id="main-footer">
        <div
            style="display:flex; justify-content:space-between; align-items:center; padding-bottom:12px; font-weight:800;">
            <span id="total-qty-text">ì´ 0ê°œ ì„ íƒ</span><span id="total-price-text"
                style="color:var(--nego-orange); font-size:1.35rem;">0ì›</span>
        </div><button class="main-submit-btn" onclick="openConfirm()">ì£¼ë¬¸í•˜ê¸°</button>
    </div>
    <div id="system-modal" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content" style="text-align: center; width: 85%; max-width: 350px; padding: 25px 20px;">
            <div id="sys-modal-msg"
                style="margin: 10px 0 25px; font-weight: 700; font-size: 1.05rem; line-height: 1.5; color: var(--item-black); white-space: pre-wrap;">
            </div>
            <div id="sys-modal-btns" style="display: flex; gap: 10px; justify-content: center;"></div>
        </div>
    </div>
    <!-- ì£¼ë¬¸ë‚´ì—­ ëª¨ë‹¬ -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="padding: 12px 20px 0 20px; flex-shrink: 0;">
                <h3 id="history-modal-title" style="margin: 0 0 12px 0; font-weight: 900; text-align: center;">ì£¼ë¬¸ë‚´ì—­</h3>
                <div
                    style="display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; border-bottom: 1.5px solid #eee; padding-bottom: 10px;">
                    <button class="date-btn" id="btn-sort-order" onclick="changeSortMode('timestamp')"
                        style="height:36px; font-size:1rem; flex:1;">ì£¼ë¬¸ì¼ìˆœ</button>
                    <button class="date-btn active" id="btn-sort-pickup" onclick="changeSortMode('pickupDate')"
                        style="height:36px; font-size:1rem; flex:1;">í”½ì—…ì¼ìˆœ</button>
                </div>
                <div style="display: flex; justify-content: center; gap: 6px; margin-bottom: 5px;">
                    <button class="date-btn" id="filter-all" onclick="filterHistory('all')"
                        style="height:32px; font-size:0.9rem; flex:1; padding:0;">ì „ì²´</button>
                    <button class="date-btn active" id="filter-today" onclick="filterHistory('today')"
                        style="height:32px; font-size:0.9rem; flex:1; padding:0;">ì˜¤ëŠ˜</button>
                    <button class="date-btn" id="filter-week" onclick="filterHistory('week')"
                        style="height:32px; font-size:0.9rem; flex:1; padding:0;">1ì£¼ì¼</button>
                    <button class="date-btn" id="filter-month" onclick="filterHistory('month')"
                        style="height:32px; font-size:0.9rem; flex:1; padding:0;">1ê°œì›”</button>
                </div>
                <div style="display: flex; justify-content: flex-end; padding: 0;">
                    <button id="btn-sort-dir" onclick="toggleSortDir()"
                        style="height: 24px; width: 32px; padding: 0; background: none; border: none; color: #999; display: flex; align-items: center; justify-content: center; cursor: pointer; outline: none; margin-right: -4px;">
                    </button>
                </div>
            </div>
            <div id="history-list" style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; text-align: left;">
                <!-- ë™ì  ìƒì„± -->
            </div>
            <div style="padding: 15px 10px; border-top: 1px solid #f5f5f5; flex-shrink: 0;">
                <button class="btn-common btn-close" onclick="closeModal('history-modal')"
                    style="margin-top: 0;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    <script>const API_URL = 'https://script.google.com/macros/s/AKfycbyFbHPPmp4mzOPwUVzCEDna0-sts_S5-FD6GeefGY30vhDIkOnAdgAFdlL0gSTfmiw/exec';

        // [ì¹´ì¹´ì˜¤ ì´ˆê¸°í™”]
        try {
            if (typeof Kakao !== 'undefined') {
                Kakao.init('a968b0ece368c55cbffedea6e46ae16b');
                console.log('Kakao SDK Initialized');
            }
        } catch (e) { console.error('Kakao Init Error:', e); }

        let productsData = [];
        let cart = {}; // { ìƒí’ˆëª…: ìˆ˜ëŸ‰ } ì €ì¥ìš© ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ
        let isHistoryProcessing = false; // ì£¼ë¬¸ë‚´ì—­ ì²˜ë¦¬ ì¤‘ í”Œë˜ê·¸ ì¶”ê°€

        // [ìŠ¤í¬ë¡¤ ë°©ì§€]
        function checkScrollLock() {
            const modals = document.querySelectorAll('.modal-overlay');
            const sideMenu = document.getElementById('side-menu');
            let isAnyOpen = sideMenu.classList.contains('open');

            if (!isAnyOpen) {
                for (let m of modals) {
                    if (window.getComputedStyle(m).display === 'flex') {
                        isAnyOpen = true;
                        break;
                    }
                }
            }
            document.body.style.overflow = isAnyOpen ? 'hidden' : '';
        }

        // [ì‹œìŠ¤í…œ ëª¨ë‹¬]
        function showSystemModal(msg, type, yesCallback, noCallback) {
            const modal = document.getElementById('system-modal');
            const msgDiv = document.getElementById('sys-modal-msg');
            const btnDiv = document.getElementById('sys-modal-btns');

            msgDiv.innerText = msg;
            btnDiv.innerHTML = '';

            if (type === 'confirm') {
                const btnNo = document.createElement('button');
                btnNo.className = 'btn-common btn-close';
                btnNo.style.height = '48px';
                btnNo.style.fontSize = '1rem';
                btnNo.innerText = 'ì·¨ì†Œ';

                btnNo.onclick = () => {
                    modal.style.display = 'none';
                    checkScrollLock();
                    if (noCallback) noCallback();
                }

                    ;

                const btnYes = document.createElement('button');
                btnYes.className = 'btn-common btn-primary';
                btnYes.style.height = '48px';
                btnYes.style.fontSize = '1rem';
                btnYes.innerText = 'í™•ì¸';

                btnYes.onclick = async () => {
                    if (yesCallback) {
                        // yesCallbackì´ trueë¥¼ ë°˜í™˜í•˜ë©´ ëª¨ë‹¬ì„ ìë™ìœ¼ë¡œ ë‹«ì§€ ì•ŠìŒ
                        const preventClose = await yesCallback(btnYes, btnNo);
                        if (preventClose === true) return;
                    }
                    modal.style.display = 'none';
                    checkScrollLock();
                }

                    ;

                btnDiv.appendChild(btnNo);
                btnDiv.appendChild(btnYes);
            }

            else {
                // alert
                const btnOk = document.createElement('button');
                btnOk.className = 'btn-common btn-primary';
                btnOk.style.height = '48px';
                btnOk.style.fontSize = '1rem';
                btnOk.innerText = 'í™•ì¸';

                btnOk.onclick = () => {
                    modal.style.display = 'none';
                    checkScrollLock();
                    if (yesCallback) yesCallback();
                }

                    ;
                btnDiv.appendChild(btnOk);
            }

            modal.style.display = 'flex';
            checkScrollLock();
        }

        // [ì œì–´] í–„ë²„ê±° ë©”ë‰´ ë° ëª¨ë‹¬
        function toggleMenu() {
            const side = document.getElementById('side-menu');
            const overlay = document.getElementById('side-menu-overlay');
            const isOpen = side.classList.contains('open');
            side.classList.toggle('open');
            overlay.style.display = isOpen ? 'none' : 'block';
            checkScrollLock();
        }

        function openSideModal(id) {
            toggleMenu();
            document.getElementById(id).style.display = 'flex';
            checkScrollLock();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            checkScrollLock();
        }

        // [í”„ë¡œí•„] ì €ì¥ ë° ë¡œë“œ
        function saveProfile() {
            const name = document.getElementById('input-name').value;
            const phone = document.getElementById('input-phone').value;
            const greeting = document.getElementById('menu-greeting');

            if (!name.trim() || !phone.trim()) {
                showSystemModal("ì£¼ë¬¸ìëª…ê³¼ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert');
                return;
            }

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            localStorage.setItem('moket_user_name', name);
            localStorage.setItem('moket_user_phone', phone);

            if (name.trim()) {
                greeting.innerHTML = `<span class="name-badge">${name}</span>ë‹˜`;
            }

            else {
                greeting.innerHTML = `<span class="name-badge">ì£¼ë¬¸ì</span>ë‹˜`;
            }

            closeModal('profile-modal');
            const confirmModal = document.getElementById('save-confirm-modal');
            confirmModal.style.display = 'flex';

            setTimeout(() => {
                confirmModal.style.display = 'none';
                checkScrollLock();
            }

                , 1500);
        }

        function loadProfile() {
            const name = localStorage.getItem('moket_user_name');
            const phone = localStorage.getItem('moket_user_phone');

            if (name) {
                document.getElementById('input-name').value = name;

                document.getElementById('menu-greeting').innerHTML = `<span class="name-badge">${name}</span>ë‹˜`;
            }

            if (phone) {
                document.getElementById('input-phone').value = phone;
            }
        }

        // [ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸]
        function loginWithKakao() {
            if (typeof Kakao === 'undefined' || !Kakao.isInitialized()) {
                showSystemModal("ì¹´ì¹´ì˜¤ SDK ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'alert');
                return;
            }

            Kakao.Auth.login({
                success: function (authObj) {
                    Kakao.API.request({
                        url: '/v2/user/me',
                        success: function (res) {
                            const kakaoName = res.kakao_account.profile.nickname;
                            if (kakaoName) {
                                localStorage.setItem('kakao_nickname', kakaoName); // ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„ ì €ì¥
                                document.getElementById('input-name').value = kakaoName;

                                // ê°•ì œ ë¡œê·¸ì¸ ëª¨ë“œ í•´ì œ
                                const modal = document.getElementById('profile-modal');
                                modal.classList.remove('login-forced');
                                document.getElementById('profile-modal-title').innerText = "ì£¼ë¬¸ì ì •ë³´ ì…ë ¥";
                                document.getElementById('btn-kakao-login').style.display = "none"; // ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¹€

                                showSystemModal(`${kakaoName}ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤!\në§ˆì§€ë§‰ìœ¼ë¡œ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ê³  [ì €ì¥í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, 'alert');
                            }
                        },
                        fail: function (error) {
                            console.error(error);
                            showSystemModal("ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'alert');
                        }
                    });
                },
                fail: function (err) {
                    console.error(err);
                    showSystemModal("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'alert');
                }
            });
        }

        // [ì£¼ë¬¸ë‚´ì—­] ì €ì¥ ë° ì¡°íšŒ
        function saveOrderToHistory(orderData) {
            const history = JSON.parse(localStorage.getItem('moket_order_history') || '[]');
            history.push(orderData); // ìˆœì°¨ì ìœ¼ë¡œ ì¶”ê°€
            localStorage.setItem('moket_order_history', JSON.stringify(history));
        }

        // [ì£¼ë¬¸ë‚´ì—­] ìë™ ì‚­ì œ (í”½ì—…ì¼ ê¸°ì¤€ 8ì¼ì§¸ ìì •)
        function cleanExpiredOrders() {
            const history = JSON.parse(localStorage.getItem('moket_order_history') || '[]');
            if (history.length === 0) return;

            const now = new Date();
            // ì˜¤ëŠ˜ ìì • (ì‹œê°„/ë¶„/ì´ˆ ì œê±°)
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

            const filteredHistory = history.filter(order => {
                if (!order.pickupDate) return false; // í”½ì—…ì¼ ì •ë³´ê°€ ì—†ëŠ” êµ¬ë²„ì „ ë‚´ì—­ì€ ì‚­ì œ

                const pickup = new Date(order.pickupDate);
                if (isNaN(pickup.getTime())) return false; // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œë„ ì‚­ì œ

                // í”½ì—…ì¼ ê¸°ì¤€ 8ì¼ì§¸ ìì • ê³„ì‚° (ì˜ˆ: 1ì¼ í”½ì—… -> 9ì¼ 00:00 ì‚­ì œ)
                const expiryTime = new Date(pickup.getFullYear(), pickup.getMonth(), pickup.getDate() + 8).getTime();

                return today < expiryTime;
            });

            if (filteredHistory.length !== history.length) {
                localStorage.setItem('moket_order_history', JSON.stringify(filteredHistory));
            }
        }

        // [ì‹œê°„ í¬ë§·] YYYY-MM-DD (ìš”ì¼) HH:mm
        function formatOrderDate(dateInput) {
            const d = new Date(dateInput);
            if (isNaN(d.getTime())) return dateInput;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            const week = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayOfWeek = week[d.getDay()];
            return `${y}-${m}-${day} (${dayOfWeek}) ${hh}:${mm}`;
        }

        // í”½ì—…ì¼ í¬ë§·] YYYY-MM-DD (ìš”ì¼)
        function formatPickupDate(dateInput) {
            const d = new Date(dateInput);
            if (isNaN(d.getTime())) return dateInput;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const week = ['ì¼',
                'ì›”',
                'í™”',
                'ìˆ˜',
                'ëª©',
                'ê¸ˆ',
                'í† '];
            const dayOfWeek = week[d.getDay()];
            return `${y}-${m}-${day} (${dayOfWeek})`;
        }

        let fullHistoryData = []; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ë°ì´í„° ì €ì¥
        let currentSortBy = 'pickupDate'; // 'pickupDate' (í”½ì—…ì¼) ê¸°ë³¸ê°’
        let currentSortDir = 'asc'; // í”½ì—…ì¼ ê¸°ì¤€ì€ ì˜¤ë¦„ì°¨ìˆœ(ì˜¤ëŠ˜->ë¯¸ë˜)ì´ ê¸°ë³¸
        let currentFilter = 'all'; // 'ì „ì²´' ê¸°ë³¸ê°’

        function toggleSortDir() {
            currentSortDir = (currentSortDir === 'desc') ? 'asc' : 'desc';
            renderHistory();
        }

        async function openHistoryModal() {
            const name = document.getElementById('input-name').value;
            const phone = document.getElementById('input-phone').value;

            if (!name || !phone) {
                showSystemModal("ì£¼ë¬¸ìëª…ê³¼ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert');
                return;
            }

            // [ì¶”ê°€] ëª¨ë‹¬ì„ ì—´ ë•Œë§ˆë‹¤ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™” (í”½ì—…ì¼ìˆœ, ì˜¤ëŠ˜)
            currentSortBy = 'pickupDate';
            currentFilter = 'all';
            currentSortDir = 'asc'; // ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì´ˆê¸°í™” (ì˜¤ëŠ˜ í•­ëª©ì´ ìœ„ë¡œ)

            // ë²„íŠ¼ UI ì´ˆê¸°í™”
            document.getElementById('btn-sort-order').classList.remove('active');
            document.getElementById('btn-sort-pickup').classList.add('active');
            document.getElementById('filter-all').classList.add('active');
            document.getElementById('filter-today').classList.remove('active');
            document.getElementById('filter-week').classList.remove('active');
            document.getElementById('filter-month').classList.remove('active');

            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            const title = document.getElementById('history-modal-title');

            // íƒ€ì´í‹€ ë™ì  ë³€ê²½ (ì£¼ë¬¸ìëª… ì˜¤ë Œì§€ìƒ‰)
            const displayName = name.trim() || "ì£¼ë¬¸ì";
            title.innerHTML = `<span style="color:var(--nego-orange);">${displayName}</span>ë‹˜ì˜ ì£¼ë¬¸ë‚´ì—­`;

            modal.style.display = 'flex';
            checkScrollLock();

            // 1. [ë¡œì»¬ ìºì‹œ] ì´ì „ì— ë¶ˆëŸ¬ì˜¨ ë‚´ì—­ì´ ìˆë‹¤ë©´ ì¦‰ì‹œ í‘œì‹œ (ì‚¬ìš©ìë³„ êµ¬ë¶„)
            const cacheKey = `history_cache_${name}_${phone}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                fullHistoryData = JSON.parse(cached);
                renderHistory();
            } else {
                list.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:50px 0; color:#999;"><div class="loading-spinner" style="margin-bottom:15px;"></div>ë‚´ì—­ì„ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...</div>';
            }

            try {
                // 2. [1ë‹¨ê³„ ë¡œë”©] ì˜¤ëŠ˜(ìµœê·¼) ë‚´ì—­ë§Œ ë¹ ë¥´ê²Œ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸
                const recentUrl = `${API_URL}?header=history&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&scope=recent`;
                const resRecent = await fetch(recentUrl);
                const recentData = await resRecent.json();

                if (recentData && recentData.result === 'error') throw new Error(recentData.message);

                if (Array.isArray(recentData)) {
                    // ë°ì´í„° ë³‘í•© (ê¸°ì¡´ ìºì‹œì™€ í•©ì¹˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“¦)
                    const recentKeys = new Set(recentData.map(o => (o.timestamp + o.item).trim()));
                    const others = (fullHistoryData || []).filter(o => !recentKeys.has((o.timestamp + o.item).trim()));
                    fullHistoryData = [...recentData, ...others];
                    renderHistory();
                }

                // 3. [2ë‹¨ê³„ ë¡œë”©] ì „ì²´ ë‚´ì—­ ë°°ê²½ì—ì„œ ì²œì²œíˆ ê°€ì ¸ì˜¤ê¸°
                const allUrl = `${API_URL}?header=history&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&scope=all`;
                fetch(allUrl).then(res => res.json()).then(allData => {
                    if (Array.isArray(allData)) {
                        fullHistoryData = allData;
                        localStorage.setItem(cacheKey, JSON.stringify(fullHistoryData));
                        renderHistory();
                    }
                }).catch(err => console.error("ì „ì²´ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:", err));

            } catch (e) {
                console.error("ì—­ì‚¬ ë¡œë“œ ì‹¤íŒ¨:", e);
                if (!fullHistoryData || fullHistoryData.length === 0) {
                    list.innerHTML = `<div style="text-align:center; color:#ff4d4d; padding:20px; font-size:0.9rem;">ğŸš« ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ<br><br><span style="color:#455464;font-size:0.8rem;">${e.message || "ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”."}</span></div>`;
                }
            }
        }

        function changeSortMode(mode) {
            currentSortBy = mode;
            // ëª¨ë“œ ë³€ê²½ ì‹œ ì ì ˆí•œ ê¸°ë³¸ ì •ë ¬ ë°©í–¥ ì„¤ì •
            currentSortDir = (mode === 'timestamp') ? 'desc' : 'asc';

            document.getElementById('btn-sort-order').classList.toggle('active', mode === 'timestamp');
            document.getElementById('btn-sort-pickup').classList.toggle('active', mode === 'pickupDate');
            renderHistory();
        }

        function filterHistory(type) {
            currentFilter = type;
            // ë²„íŠ¼ í™œì„±í™” ì²˜ë¦¬
            const buttons = ['all', 'today', 'week', 'month'];
            buttons.forEach(b => {
                const btn = document.getElementById('filter-' + b);
                if (btn) btn.classList.toggle('active', b === type);
            });
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            if (!fullHistoryData || fullHistoryData.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#455464; padding:50px 0;">ì£¼ë¬¸ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // í•œê¸€ ë‚ ì§œ ë¬¸ìì—´ íŒŒì‹± ìœ í‹¸ë¦¬í‹°
            const parseKRDate = (str) => {
                if (!str) return new Date(0);
                const matches = str.match(/\d+/g);
                if (!matches || matches.length < 3) return new Date(0);
                return new Date(matches[0], matches[1] - 1, matches[2], matches[3] || 0, matches[4] || 0, matches[5] || 0);
            };

            const now = new Date();
            const filtered = fullHistoryData.filter(item => {
                if (currentFilter === 'all') return true;
                const itemDate = parseKRDate(item[currentSortBy]);

                if (currentSortBy === 'timestamp') {
                    // ì£¼ë¬¸ì¼ìˆœ: ê³¼ê±° ë‚´ì—­ í•„í„°ë§ (ìµœê·¼ 24ì‹œê°„/7ì¼/30ì¼)
                    const diffDays = (now - itemDate) / (1000 * 60 * 60 * 24);
                    if (currentFilter === 'today') return diffDays < 1;
                    if (currentFilter === 'week') return diffDays < 7;
                    if (currentFilter === 'month') return diffDays < 30;
                } else {
                    // í”½ì—…ì¼ìˆœ: ë¯¸ë˜ ì¼ì • í•„í„°ë§ (ì˜¤ëŠ˜/7ì¼ ì´ë‚´/30ì¼ ì´ë‚´)
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const targetDate = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate());
                    // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ë¯¸ë˜ëŠ” ì–‘ìˆ˜)
                    const diffDays = Math.floor((targetDate - todayStart) / (1000 * 60 * 60 * 24));

                    if (currentFilter === 'today') return diffDays === 0;
                    if (currentFilter === 'week') return diffDays >= 0 && diffDays <= 7;
                    if (currentFilter === 'month') return diffDays >= 0 && diffDays <= 30;
                }
                return true;
            });

            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#455464; padding:50px 0;">í•´ë‹¹ ê¸°ê°„ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ì •ë ¬ ë¡œì§ (ì·¨ì†Œëœ í•­ëª©ì€ ë¬´ì¡°ê±´ ìµœí•˜ë‹¨ìœ¼ë¡œ, ê·¸ ì™¸ì—ëŠ” ì„ íƒí•œ ê¸°ì¤€ì— ë”°ë¼ ì •ë ¬)
            filtered.sort((a, b) => {
                const isACancelled = (a.item && a.item.includes('[ì·¨ì†Œ]')) || (a.note && a.note.includes('[ì·¨ì†Œ]'));
                const isBCancelled = (b.item && b.item.includes('[ì·¨ì†Œ]')) || (b.note && b.note.includes('[ì·¨ì†Œ]'));

                if (isACancelled !== isBCancelled) {
                    return isACancelled ? 1 : -1; // ì·¨ì†Œëœ ê±´ì„ ë’¤ë¡œ(1) ë³´ëƒ„
                }

                const valA = parseKRDate(a[currentSortBy]);
                const valB = parseKRDate(b[currentSortBy]);
                return currentSortDir === 'desc' ? valB - valA : valA - valB;
            });

            filtered.forEach(order => {
                const isCancelled = (order.item && order.item.includes('[ì·¨ì†Œ]')) || (order.note && order.note.includes('[ì·¨ì†Œ]'));
                const orderDiv = document.createElement('div');
                orderDiv.style.borderBottom = '1px solid #eee';
                orderDiv.style.padding = '15px 0';
                if (isCancelled) {
                    orderDiv.style.opacity = '0.6';
                    orderDiv.style.textDecoration = 'line-through';
                }

                // [ìˆ˜ì •] í™”ë©´ì—ëŠ” ë‚ ì§œë§Œ í‘œì‹œí•˜ê³ , ê¸°ëŠ¥(ì·¨ì†Œ ë“±)ì—ëŠ” ì „ì²´ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©
                const orderTimeFull = order.timestamp;
                const orderTime = orderTimeFull.replace(/\s\d{2}:\d{2}:\d{2}$/, ''); // HH:mm:ss ì œê±°
                const isReceived = (order.received === true || order.received === "TRUE");
                const pickupDisp = order.pickupDate || 'ì •ë³´ì—†ìŒ';

                const orderDateStyle = currentSortBy === 'timestamp' ? 'color:var(--nego-orange); font-weight:700;' : 'color:#455464;';
                const pickupDateStyle = currentSortBy === 'pickupDate' ? 'color:var(--nego-orange); font-weight:700;' : 'color:#455464;';

                // [ìˆ˜ì •] ì£¼ë¬¸ì¼ìˆœ - ì˜¤ëŠ˜ ì¸ ê²½ìš°ë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                const canDelete = (currentSortBy === 'timestamp' && currentFilter === 'today');

                orderDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                        <div style="flex:1; padding-right:10px;">
                            <div style="font-size:1.1rem; font-weight:800; color:var(--item-black); line-height:1.2; margin-bottom:6px;">${order.item}</div>
                            <div style="font-size:0.75rem; display:flex; flex-direction:column; gap:2px;">
                                <div style="${orderDateStyle}">ì£¼ë¬¸ì¼: ${orderTime}</div>
                                <div style="${pickupDateStyle}">í”½ì—…ì¼: ${pickupDisp}</div>
                            </div>
                        </div>
                        <div style="text-align:right; min-width:90px; display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                            <div style="font-size:0.85rem; color:#455464; font-weight:700;">${order.qty}ê°œ / ${parseInt(order.total || 0).toLocaleString()}ì›</div>
                            <div style="font-size:0.95rem; font-weight:800; color:${isReceived ? '#4CAF50' : '#FF6D00'};">
                                ${isReceived ? 'ìˆ˜ë ¹ì™„ë£Œ' : 'ë¯¸ìˆ˜ë ¹'}
                            </div>
                            ${canDelete ? `<button onclick="deleteOrderServer('${orderTimeFull}', '${order.name}', '${order.item}', '${order.pickupDate}')" 
                                 style="margin-top:4px; width:100%; height:28px; background:#eff2f5; color:#666; border:none; border-radius:6px; font-size:0.75rem; font-weight:700; cursor:pointer;">ì£¼ë¬¸ì·¨ì†Œ</button>` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(orderDiv);
            });
        }

        async function deleteOrderServer(timestamp, name, item, pickupDate) {
            if (isHistoryProcessing) return;

            const displayItem = item.replace(/['"]/g, '');
            showSystemModal(`[${displayItem}]\nì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'confirm', async (btnYes, btnNo) => {
                try {
                    isHistoryProcessing = true;
                    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ ë° ì „ì²´ í„°ì¹˜ ë°©ì§€
                    btnYes.disabled = true;
                    btnNo.disabled = true;
                    btnYes.innerText = "ì²˜ë¦¬ ì¤‘...";
                    btnYes.style.opacity = "0.7";
                    btnNo.style.opacity = "0.5";

                    // í™”ë©´ ì „ì²´ í„°ì¹˜ ë§‰ê¸°ìš© íˆ¬ëª… ì»¤ë²„ (ì„ì‹œ ìƒì„±)
                    const blocker = document.createElement('div');
                    blocker.id = 'global-touch-blocker';
                    blocker.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:10001;background:transparent;';
                    document.body.appendChild(blocker);

                    const payload = {
                        header: 'delete',
                        timestamp: String(timestamp).trim(),
                        name: String(name).trim(),
                        item: String(item).trim(),
                        pickupDate: String(pickupDate).trim()
                    };
                    const resp = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const result = await resp.json();

                    // ì²˜ë¦¬ ì™„ë£Œ í›„ ë¸”ë¡œì»¤ ì œê±° ë° ëª¨ë‹¬ ë‹«ê¸°
                    if (blocker) blocker.remove();
                    document.getElementById('system-modal').style.display = 'none';
                    checkScrollLock();

                    if (result.result === 'success') {
                        showSystemModal("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'alert');
                        openHistoryModal();
                    } else {
                        showSystemModal(result.message || "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'alert');
                    }
                } catch (e) {
                    const blocker = document.getElementById('global-touch-blocker');
                    if (blocker) blocker.remove();
                    document.getElementById('system-modal').style.display = 'none';
                    checkScrollLock();
                    showSystemModal("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'alert');
                } finally {
                    isHistoryProcessing = false;
                }
                return true; // showSystemModalì´ ìë™ìœ¼ë¡œ ë‹«ì§€ ì•Šë„ë¡ í•¨
            });
        }

        // [ë‚ ì§œ] ìš”ì¼ í‘œì‹œ ë¡œì§
        function formatDateWithDay(input) {
            const d = new Date(input);
            if (isNaN(d.getTime())) return input;
            const week = ['ì¼',
                'ì›”',
                'í™”',
                'ìˆ˜',
                'ëª©',
                'ê¸ˆ',
                'í† '];

            return `${d.getMonth() + 1}ì›”${d.getDate()}ì¼(${week[d.getDay()]})`;
        }

        // [ì´ë¯¸ì§€] ë“œë¼ì´ë¸Œ ID ì²˜ë¦¬ (ì „ì²´ URLì—ì„œë„ ID ì¶”ì¶œ ê°€ëŠ¥í•˜ê²Œ ê°•í™”)
        function getImgUrl(input, size = 1000) {
            if (!input) return '';
            let id = input.toString().trim();
            // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì „ì²´ URL(d/ID/view ë“±)ì—ì„œ IDë§Œ ì¶”ì¶œí•˜ëŠ” ì •ê·œì‹
            const driveMatch = id.match(/[-\w]{25,}/);
            if (driveMatch) id = driveMatch[0];

            return `https://drive.google.com/thumbnail?id=${id}&sz=w${size}`;
        }

        async function loadData() {
            const productArea = document.getElementById('product-list');

            // 1. [ë¡œì»¬ ìºì‹œ] ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ë Œë”ë§ (0.1ì´ˆ ì²´ê° ì†ë„)
            const cachedData = localStorage.getItem('moket_products_cache_v2');
            if (cachedData) {
                try {
                    productsData = JSON.parse(cachedData);
                    console.log("ë¡œì»¬ ìºì‹œ ë°ì´í„° ì¦‰ì‹œ í‘œì‹œ");
                    processAndRender(productsData);
                } catch (e) {
                    console.error("ìºì‹œ ë¡œë“œ ì‹¤íŒ¨:", e);
                }
            }

            try {
                // 2. [ì„œë²„ í˜¸ì¶œ] ë°°ê²½ì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                const rawData = await response.json();

                if (!Array.isArray(rawData)) {
                    if (rawData.result === "error") throw new Error(rawData.message);
                    throw new Error('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                // ë§¤í•‘ ì²˜ë¦¬
                const freshData = rawData.map(p => ({
                    ...p,
                    name: p.name || "",
                    matchKey: p.matchKey || "",
                    displayDate: formatDateWithDay(p.date),
                    images: Array.isArray(p.images) ? p.images : []
                })).filter(p => p.name && p.matchKey);

                if (freshData.length > 0) {
                    // ë°ì´í„°ê°€ ë°”ë€Œì—ˆì„ ë•Œë§Œ ë Œë”ë§ ì—…ë°ì´íŠ¸ (í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€)
                    if (JSON.stringify(freshData) !== JSON.stringify(productsData)) {
                        productsData = freshData;
                        localStorage.setItem('moket_products_cache_v2', JSON.stringify(productsData));
                        console.log("ìµœì‹  ë°ì´í„°ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸");
                        processAndRender(productsData);
                    }
                }
            }
            catch (e) {
                console.error("ë°°ê²½ ë¡œë“œ ì‹¤íŒ¨:", e);
                // ìºì‹œì¡°ì°¨ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
                if (!productsData || productsData.length === 0) {
                    productArea.innerHTML = `<div style="text-align:center; padding:50px 20px; color:#ff4d4d;">
                        ğŸš« ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                        <span style="font-size:0.8rem; color:#999;">(${e.message})</span>
                    </div>`;
                }
            }
        }

        // ë‚ ì§œ í•„í„° ìƒì„± ë° ì´ˆê¸° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ì„ ë‹´ë‹¹í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
        function processAndRender(data) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ ë°ì´í„°ë§Œ í•„í„°ë§
            const futureData = data.filter(p => {
                const pDate = new Date(p.matchKey);
                pDate.setHours(0, 0, 0, 0);
                return pDate >= today;
            });

            const uniqueDates = [...new Set(futureData.map(p => p.matchKey))].sort((a, b) => new Date(a) - new Date(b));
            const filterArea = document.getElementById('date-filters');

            // í˜„ì¬ í™œì„±í™”ëœ ë‚ ì§œ ê¸°ì–µ
            const activeBtn = filterArea.querySelector('.date-btn.active');
            const activeDate = activeBtn ? activeBtn.dataset.date : (uniqueDates.length > 0 ? uniqueDates[0] : null);

            filterArea.innerHTML = '';
            uniqueDates.forEach((date, idx) => {
                const btn = document.createElement('button');
                btn.className = `date-btn ${((!activeDate && idx === 0) || date === activeDate) ? 'active' : ''}`;
                btn.dataset.date = date;
                btn.innerText = futureData.find(p => p.matchKey === date).displayDate;
                btn.onclick = () => {
                    document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderList(date);
                };
                filterArea.appendChild(btn);
            });

            if (activeDate && uniqueDates.includes(activeDate)) renderList(activeDate);
            else if (uniqueDates.length > 0) renderList(uniqueDates[0]);
            else {
                document.getElementById('product-list').innerHTML = '<div style="text-align:center; padding:50px 0; color:#999;">í˜„ì¬ ì£¼ë¬¸ ê°€ëŠ¥í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        function renderList(targetKey) {
            const container = document.getElementById('product-list');
            container.innerHTML = '';

            productsData.filter(p => p.matchKey === targetKey).forEach(p => {
                const imgId = p.images[0];
                const thumbUrl = imgId ? getImgUrl(imgId, 300) : ''; // 300px ì¸ë„¤ì¼ ì‚¬ìš©

                const card = document.createElement('div');
                card.className = 'product-card';

                const currentQty = cart[p.name] || 0; // ì €ì¥ëœ ìˆ˜ëŸ‰ ê°€ì ¸ì˜¤ê¸°
                const stock = p.stock !== undefined && p.stock !== "" ? parseInt(p.stock) : Infinity;
                const isSoldOut = stock <= 0;
                const stockText = isFinite(stock) ? (isSoldOut ? "í’ˆì ˆ" : `ì£¼ë¬¸ê°€ëŠ¥ìˆ˜ëŸ‰ <span style="color:var(--nego-orange);">${stock}</span>ê°œ`) : "ì¬ê³ ì—¬ìœ ";

                card.innerHTML = `<div class="card-layout">
                    <div class="thumb">
                        ${imgId
                        ? `<img src="${thumbUrl}" loading="lazy" style="width:100%; height:100%; object-fit:contain;">`
                        : 'No Image'}
                    </div>
                    <div class="right-col">
                        <div class="item-info-top">
                            <div class="item-name">${p.name}</div>
                            <div class="item-price-val">${parseInt(p.price || 0).toLocaleString()}ì›</div>
                        </div>
                        <div class="item-controls-bottom-v" style="align-items: flex-end; gap: 15px;">
                            <button class="btn-detail" onclick="openDetail('${p.name.replace(/'/g, "\\'")}')" style="height: 38px; flex: 1;">ìƒì„¸ë³´ê¸°</button>
                            <div class="qty-group" style="display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1;">
                                <div class="stock-status" style="font-size:0.95rem; font-weight:800; color:${isSoldOut ? '#ff0000' : '#455464'}; letter-spacing:-0.03em;">
                                    ${stockText}
                                </div>
                                <div class="qty-controls ${currentQty > 0 ? 'selected' : ''}" style="width:100%; height: var(--qty-height); ${isSoldOut ? 'opacity:0.5; pointer-events:none;' : ''}">
                                    <button class="qty-btn" onclick="qty(this, -1)">-</button>
                                    <input class="qty-num" value="${currentQty}" readonly 
                                        style="width:32px; text-align:center; border:none; background:none; font-weight:800; font-size:1.1rem; color:var(--moket-green);" 
                                        data-name="${p.name}" data-price="${p.price}" data-stock="${stock}">
                                    <button class="qty-btn" onclick="qty(this, 1)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.appendChild(card);
            });
        }

        function qty(btn, change) {
            const input = btn.parentElement.querySelector('input');
            const name = input.dataset.name;
            const stock = input.dataset.stock ? parseFloat(input.dataset.stock) : Infinity;
            let val = Math.max(0, (cart[name] || 0) + change);

            if (val > stock) {
                showSystemModal(`í•´ë‹¹ ìƒí’ˆì˜ ì£¼ë¬¸ê°€ëŠ¥ ìˆ˜ëŸ‰ì€ ${isFinite(stock) ? stock + 'ê°œ' : 'ì—†ìŒ'}ì…ë‹ˆë‹¤.`, 'alert');
                return;
            }

            cart[name] = val; // ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (val === 0) delete cart[name]; // 0ê°œë©´ ì œê±°

            input.value = val;

            // ìˆ˜ëŸ‰ì— ë”°ë¼ ë°°ê²½ìƒ‰(í´ë˜ìŠ¤) í† ê¸€
            const controls = btn.parentElement;
            if (val > 0) controls.classList.add('selected');
            else controls.classList.remove('selected');

            updateFooter();
        }

        function updateFooter() {
            let tQ = 0,
                tP = 0;

            // ì¥ë°”êµ¬ë‹ˆ(cart) ìƒíƒœë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ì‚°
            for (const name in cart) {
                const q = cart[name];
                const product = productsData.find(p => p.name === name);
                if (product) {
                    tQ += q;
                    tP += (q * parseInt(product.price || 0));
                }
            }

            const footer = document.getElementById('main-footer');

            if (tQ > 0) {
                footer.classList.add('visible');
                document.body.classList.add('has-selection');

                document.getElementById('total-qty-text').innerText = `ì´ ${tQ}ê°œ ì„ íƒ`;

                document.getElementById('total-price-text').innerText = `${tP.toLocaleString()}ì›`;
            }

            else {
                footer.classList.remove('visible');
                document.body.classList.remove('has-selection');
            }
        }

        function openDetail(name) {
            const p = productsData.find(i => i.name === name);
            if (!p) return;
            document.getElementById('detail-title').innerText = p.name;
            document.getElementById('detail-price').innerText = parseInt(p.price || 0).toLocaleString() + 'ì›';
            document.getElementById('detail-desc').style.whiteSpace = 'pre-wrap'; // ì¤„ë°”ê¿ˆ ìœ ì§€
            document.getElementById('detail-desc').innerText = p.desc || "ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
            const slider = document.getElementById('slider-area');

            if (p.images && p.images.length > 0 && p.images[0]) {
                slider.innerHTML = p.images.map(id => `<img src="${getImgUrl(id)}" >`).join('');
            }

            else {
                slider.innerHTML = `<div class="slider-no-img">No Image</div>`;
            }

            document.getElementById('detail-overlay').style.display = 'flex';
            checkScrollLock();
            slider.scrollLeft = 0;
            const detailBody = document.querySelector('.detail-body');
            if (detailBody) detailBody.scrollTop = 0;
        }

        function openFullscreen() {
            const slider = document.getElementById('slider-area');
            const index = Math.round(slider.scrollLeft / slider.clientWidth);

            // í˜„ì¬ ìƒì„¸í˜ì´ì§€ì— ë– ìˆëŠ” ìƒí’ˆ ë°ì´í„° ì°¾ê¸°
            const name = document.getElementById('detail-title').innerText;
            const p = productsData.find(i => i.name === name);
            if (!p || !p.images || p.images.length === 0) return;

            const fsOverlay = document.getElementById('fullscreen-overlay');
            const fsSlider = document.getElementById('fullscreen-slider-area');

            // ëª¨ë“  ì´ë¯¸ì§€ ë Œë”ë§
            fsSlider.innerHTML = p.images.map(id => `
                <div class="fullscreen-slide">
                    <img src="${getImgUrl(id)}">
                </div>
            `).join('');

            fsOverlay.style.display = 'flex';
            checkScrollLock();

            // í˜„ì¬ ì¸ë±ìŠ¤ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
            setTimeout(() => {
                fsSlider.scrollLeft = index * fsSlider.clientWidth;
            }, 10);
        }

        function openConfirm() {
            const name = document.getElementById('input-name').value || "ì…ë ¥ë˜ì§€ ì•ŠìŒ";
            const phone = document.getElementById('input-phone').value || "ì…ë ¥ë˜ì§€ ì•ŠìŒ";

            const list = document.getElementById('confirm-item-list');
            list.innerHTML = `
                <div style="font-size:1.15rem; font-weight:900; color:var(--item-black); margin-bottom:12px; text-align:center;">ì£¼ë¬¸ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”</div>
                <div style="margin-bottom:15px; border-bottom:1px solid #ddd; padding-bottom:12px;">
                    <div style="font-size:1rem; font-weight:800; color:var(--item-black); margin-bottom:5px;">ì£¼ë¬¸ì ì •ë³´</div>
                    <div style="font-size:0.95rem; color:#000;">ì£¼ë¬¸ìëª…: <span style="font-weight:700; color:var(--nego-orange);">${name}</span></div>
                    <div style="font-size:0.95rem; color:#000;">ì—°ë½ì²˜: <span style="font-weight:700; color:var(--nego-orange);">${phone}</span></div>
                </div>
            `;
            let total = 0;

            // ì¥ë°”êµ¬ë‹ˆ(cart) ìƒíƒœë¥¼ ê¸°ì¤€ìœ¼ë¡œ í™•ì¸ ì°½ í‘œì‹œ
            for (const name in cart) {
                const q = cart[name];
                const product = productsData.find(p => p.name === name);
                if (product && q > 0) {
                    const sub = q * parseInt(product.price || 0);
                    total += sub;
                    list.innerHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.95rem; margin-bottom:8px;">
                            <span style="color:#333; flex:1; padding-right:10px;">${name}</span>
                            <div style="display:flex; align-items:center; min-width:100px; justify-content:flex-end;">
                                <span style="color:#888; font-size:0.85rem; width:30px; text-align:right; margin-right:10px;">${q}ê°œ</span>
                                <span style="color:#333; font-weight:700; min-width:60px; text-align:right;">${sub.toLocaleString()}ì›</span>
                            </div>
                        </div>`;
                }
            }
            document.getElementById('confirm-total-price').innerText = total.toLocaleString() + 'ì›';
            document.getElementById('confirm-overlay').style.display = 'flex';
            checkScrollLock();
        }

        async function completeOrder() {
            const submitBtn = document.getElementById('btn-submit-order');
            if (submitBtn.disabled) return; // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ì¤‘ë‹¨

            const name = document.getElementById('input-name').value;
            const phone = document.getElementById('input-phone').value;
            const allItems = [];

            // ì¥ë°”êµ¬ë‹ˆ(cart) ìƒíƒœë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë¬¸ ë°ì´í„° ìƒì„±
            for (const itemName in cart) {
                const q = cart[itemName];
                const pData = productsData.find(p => p.name === itemName);
                if (q > 0 && pData) {
                    allItems.push({
                        name: itemName,
                        qty: q,
                        price: parseInt(pData.price),
                        subtotal: q * parseInt(pData.price),
                        date: pData.matchKey
                    });
                }
            }

            if (allItems.length === 0) {
                showSystemModal("ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.", 'alert');
                return;
            }

            if (!name || !phone) {
                showSystemModal("ì£¼ë¬¸ìëª…ê³¼ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert', () => {
                    closeModal('confirm-overlay');
                    document.getElementById('profile-modal').style.display = 'flex';
                });
                return;
            }

            // í”½ì—…ì¼(date)ë³„ë¡œ ì•„ì´í…œ ê·¸ë£¹í™”
            const groups = allItems.reduce((acc, item) => {
                const d = item.date || 'unknown';
                if (!acc[d]) acc[d] = [];
                acc[d].push(item);
                return acc;
            }, {});

            const dateKeys = Object.keys(groups);

            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
                submitBtn.disabled = true;
                submitBtn.innerText = "ì²˜ë¦¬ ì¤‘...";
                submitBtn.style.opacity = "0.7";

                // ê° í”½ì—…ì¼ë³„ë¡œ ë³„ë„ ì£¼ë¬¸ ì „ì†¡ ë° ë‚´ì—­ ì €ì¥
                for (const dateKey of dateKeys) {
                    const items = groups[dateKey];
                    const total = items.reduce((sum, it) => sum + it.subtotal, 0);
                    const pickupDate = dateKey === 'unknown' ? null : dateKey;

                    const payload = {
                        header: "order",
                        name: name,
                        phone: phone,
                        kakaoName: localStorage.getItem('kakao_nickname') || name,
                        kakaoPhone: phone, // í˜„ì¬ ë³„ë„ ì¹´ì¹´ì˜¤ ì—°ë½ì²˜ë¥¼ ë°›ì§€ ì•Šìœ¼ë¯€ë¡œ ì£¼ë¬¸ ì—°ë½ì²˜ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                        items: items,
                        total: total,
                        pickupDate: pickupDate,
                        timestamp: new Date().toISOString()
                    };

                    await fetch(API_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        body: JSON.stringify(payload)
                    });

                    // saveOrderToHistory(payload); // ì£¼ë¬¸ë‚´ì—­ ì €ì¥ ë° í‘œì‹œ ê¸°ëŠ¥ ì œì™¸ ìš”ì²­ìœ¼ë¡œ ì£¼ì„ ì²˜ë¦¬
                }

                localStorage.removeItem('moket_products_cache_v2'); // ê¸°ì¡´ ì¬ê³  ë°ì´í„° ê°•ì œ ì‚­ì œ
                showSystemModal("ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!", 'alert', () => location.reload());
            } catch (err) {
                console.error(err);
                // ì—ëŸ¬ ë°œìƒ ì‹œ ë²„íŠ¼ ë³µêµ¬
                submitBtn.disabled = false;
                submitBtn.innerText = "ì£¼ë¬¸í™•ì •";
                submitBtn.style.opacity = "1";

                if (window.location.protocol === 'file:') {
                    showSystemModal("âš ï¸ ë³´ì•ˆ ê²½ê³  âš ï¸\n\ní˜„ì¬ íŒŒì¼ì„ PCì—ì„œ ì§ì ‘ ì—´ì–´ì„œ ì‹¤í–‰ ì¤‘ì´ì‹œêµ°ìš”(file://).\në¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…(CORS) ë•Œë¬¸ì— ì „ì†¡ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nVS Code 'Live Server'ë¡œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.", 'alert');
                } else {
                    showSystemModal("ì£¼ë¬¸ ì ‘ìˆ˜ ì¤‘ ì¼ë¶€ í˜¹ì€ ì „ì²´ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n(ì—ëŸ¬: " + err.message + ")", 'alert');
                }
            }
        }


        window.onload = function () {
            localStorage.removeItem('moket_order_history'); // ì£¼ë¬¸ë‚´ì—­ ë°ì´í„° ì‚­ì œ
            loadData();
            loadProfile();

            // [ìˆ˜ì •] í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê°•ì œ ë¡œê·¸ì¸ í•´ì œ (ì¼ë°˜ ëª¨ë‹¬ë¡œ í‘œì‹œ)
            const name = localStorage.getItem('moket_user_name');
            if (!name || !name.trim()) {
                setTimeout(() => {
                    const modal = document.getElementById('profile-modal');
                    modal.classList.remove('login-forced');
                    document.getElementById('profile-modal-title').innerText = "ì£¼ë¬¸ì ì •ë³´ ì…ë ¥";
                    modal.style.display = 'flex';
                    checkScrollLock();
                }, 500);
            }
        }

            ;
    </script>
</body>

</html>